version: 2
jobs:
  test:
    machine: true
    steps:
      - checkout
      - run: make ci:enable:k8s
      - run: make ci:enable:helm
      - run: make apply
      - run: make test
  "checkout-repo":
    machine: true
    steps:
      - checkout
      - run: git checkout gh-pages
      - persist_to_workspace:
         root: .
         paths:
          - ./*
  "build-repo":
    docker:
      - image: dtzar/helm-kubectl:2.9.1
    steps:
      - checkout
      - run: helm init --client-only
      - attach_workspace:
          at: ./dist
      - run: make ci:diff | xargs -I{} helm package {} -d dist/
      - run: helm repo index dist/ --url https://chatwork.github.io/charts
      - persist_to_workspace:
         root: dist
         paths:
          - ./*
  "publish-repo":
    docker:
      - image: buildpack-deps:jessie
    steps:
      # ~/.ssh/config
      # Host github.com
      #   IdentitiesOnly yes
      #   IdentityFile /root/.ssh/id_rsa_xxxx
      #   StrictHostKeyChecking no
      - add_ssh_keys:
          fingerprints:
            - "56:a1:e2:9e:89:f8:c2:87:7c:5a:89:bd:31:ed:88:2d"
      - run: echo -e "  StrictHostKeyChecking no\n" >> ~/.ssh/config
      - attach_workspace:
          at: .
      - run: git commit -a --allow-empty-message -m '' && git push origin gh-pages
workflows:
  version: 2
  integration:
    jobs:
      # integration
      - test
      # delivery
      - "checkout-repo":
          filters:
            branches:
              only: example-charts
      - "build-repo":
          requires:
            - checkout-repo
      - "publish-repo":
          requires:
            - test
            - build-repo
